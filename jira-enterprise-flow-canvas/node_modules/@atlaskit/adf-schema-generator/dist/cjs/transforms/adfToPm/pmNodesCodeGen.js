"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildNodeMarksForImport = exports._nodeInterfaces = void 0;
exports.pmNodesCodeGen = pmNodesCodeGen;
var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _camelCase = _interopRequireDefault(require("lodash/camelCase"));
var _codeGenHelpers = require("./codeGenHelpers");
var _isAnyOf = require("../../utils/isAnyOf");
var _adfToPmAutogeneratedMessage = require("./adfToPmAutogeneratedMessage");
var _objectToSortedArray = require("./objectToSortedArray");
var _nodeInterfaces = exports._nodeInterfaces = function _nodeInterfaces(nodeName, nodeTypeDefinitionName, nodeTypeDefinition) {
  var _nodeTypeDefinition$c, _nodeTypeDefinition$m, _nodeTypeDefinition$a;
  var additionalAttributeTypes = [];
  var _attrs = function _attrs(name, attrs) {
    if (!attrs || !Object.keys(attrs).length) {
      return null;
    }
    return "".concat(name, ": {").concat((0, _codeGenHelpers.buildADFAttributesTypes)(attrs).join(';'), "},");
  };
  var _anyOfAttrs = function _anyOfAttrs(name, anyOf) {
    if (!anyOf) {
      return null;
    }
    var additionalAttributeName = function additionalAttributeName(index) {
      return "".concat(nodeName, "Attributes").concat(index);
    };
    anyOf.forEach(function (attr, index) {
      additionalAttributeTypes.push((0, _codeGenHelpers._interface)(additionalAttributeName(index), (0, _codeGenHelpers.buildADFAttributesTypes)(attr).join(';')));
    });
    return "".concat(name, ": ").concat(anyOf.map(function (_, index) {
      return additionalAttributeName(index);
    }).join('|'));
  };
  var _string = function _string(name, value) {
    if (!value) {
      return null;
    }
    return "".concat(name, ": '").concat(value, "'");
  };
  var _contentTypes = function _contentTypes(name, value) {
    if (!value || value.length === 0) {
      return null;
    }
    var types = value.map(function (v) {
      return (0, _codeGenHelpers.convertTypeToTypeName)(v, '');
    });
    return "".concat(name, ": Array<").concat(types.sort().join('|'), ">");
  };
  var _nodeMarks = function _nodeMarks(name, value) {
    if (!value || value.length === 0) {
      return null;
    }
    return "".concat(name, ": Array<").concat(value.sort().join('|'), ">");
  };
  var type = _string('type', nodeTypeDefinition.type);
  var content = _contentTypes('content', (_nodeTypeDefinition$c = nodeTypeDefinition.content) !== null && _nodeTypeDefinition$c !== void 0 ? _nodeTypeDefinition$c : []);
  var marks = _nodeMarks('marks', (_nodeTypeDefinition$m = nodeTypeDefinition.marks) !== null && _nodeTypeDefinition$m !== void 0 ? _nodeTypeDefinition$m : []);
  var attrs = (0, _isAnyOf.isAnyOf)(nodeTypeDefinition.attrs) ? _anyOfAttrs('attrs', (_nodeTypeDefinition$a = nodeTypeDefinition.attrs) === null || _nodeTypeDefinition$a === void 0 ? void 0 : _nodeTypeDefinition$a.anyOf) : _attrs('attrs', nodeTypeDefinition.attrs);
  var body = [type, content, marks, attrs].filter(function (v) {
    return !!v;
  }).join(',');
  return [].concat(additionalAttributeTypes, [(0, _codeGenHelpers._interface)(nodeTypeDefinitionName, body), (0, _codeGenHelpers._type)(nodeName, "PMNode & ".concat(nodeTypeDefinitionName))]).join('\n\n');
};
var buildNodeMarksForImport = exports.buildNodeMarksForImport = function buildNodeMarksForImport(nodeResMap) {
  var markTypes = [];
  Object.values(nodeResMap).forEach(function (_ref) {
    var marks = _ref.nodeTypeDefinition.marks;
    markTypes.push.apply(markTypes, (0, _toConsumableArray2.default)(marks !== null && marks !== void 0 ? marks : []));
  });
  return (0, _toConsumableArray2.default)(new Set(markTypes));
};
function pmNodesCodeGen(nodeResMap) {
  return (0, _codeGenHelpers._codeBlock)(_adfToPmAutogeneratedMessage.adfToPmAutogeneratedMessage, (0, _codeGenHelpers._namedImport)('../../schema/createPMSpecFactory', 'createPMNodeSpecFactory'), (0, _codeGenHelpers._namedTypeImport)('@atlaskit/editor-prosemirror/model', 'Node as PMNode'), _codeGenHelpers._namedTypeImport.apply(void 0, ['./nodeGroupTypes'].concat(['InlineDefinition', 'BlockDefinition', 'BlockRootOnlyDefinition'])), _codeGenHelpers._namedTypeImport.apply(void 0, ['./markTypes'].concat((0, _toConsumableArray2.default)(buildNodeMarksForImport(nodeResMap).sort()))), (0, _objectToSortedArray.objectToSortedArray)(nodeResMap).map(function (_ref2) {
    var _ref3 = (0, _slicedToArray2.default)(_ref2, 2),
      key = _ref3[0],
      _ref3$ = _ref3[1],
      nodeTypeDefinition = _ref3$.nodeTypeDefinition,
      pmNodeSpec = _ref3$.pmNodeSpec;
    var functionName = (0, _camelCase.default)(key);
    var nodeName = (0, _codeGenHelpers.convertTypeToTypeName)(key, 'Node');
    var nodeTypeDefinitionName = (0, _codeGenHelpers.convertTypeToTypeName)(key, 'Definition');
    return (0, _codeGenHelpers._codeBlock)(
    // build node types
    _nodeInterfaces(nodeName, nodeTypeDefinitionName, nodeTypeDefinition),
    // build node speec
    (0, _codeGenHelpers._functionCallToVariable)(functionName, "createPMNodeSpecFactory<".concat(nodeName, ">"), [(0, _codeGenHelpers.stringifyWithUndefined)(pmNodeSpec)]));
  }).join('\n\n'));
}