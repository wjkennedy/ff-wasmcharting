const NESTED_METRIC_SEPARATOR = '/';
function filterEntry(entry) {
  return !(!entry || typeof entry !== 'object' || entry.startTime < 0 || entry.duration < 0);
}
function mapEntry(entry) {
  return {
    startTime: Math.round(entry.startTime),
    duration: Math.round(entry.duration),
    ...(entry.size ? {
      size: Math.round(entry.size)
    } : {})
  };
}
const SSR_PREFIX = 'ssr';
function mapKey(key) {
  if (key === 'total') {
    return SSR_PREFIX;
  }
  return `${SSR_PREFIX}${NESTED_METRIC_SEPARATOR}${key}`;
}
let config;
export function configure(ssrConfig) {
  config = ssrConfig;
}
function getPerformanceNavigationTiming() {
  var _performance$getEntri;
  // getEntriesByType doesn't change the returned type based on the given type key
  // eslint-disable-next-line @typescript-eslint/consistent-type-assertions
  return (_performance$getEntri = performance.getEntriesByType('navigation')) === null || _performance$getEntri === void 0 ? void 0 : _performance$getEntri[0];
}
function getServerTimingsByName() {
  var _getPerformanceNaviga, _getPerformanceNaviga2, _getPerformanceNaviga3;
  const serverTimingsByName = Object.fromEntries((_getPerformanceNaviga = (_getPerformanceNaviga2 = getPerformanceNavigationTiming()) === null || _getPerformanceNaviga2 === void 0 ? void 0 : (_getPerformanceNaviga3 = _getPerformanceNaviga2.serverTiming) === null || _getPerformanceNaviga3 === void 0 ? void 0 : _getPerformanceNaviga3.map(timing => [timing.name, timing])) !== null && _getPerformanceNaviga !== void 0 ? _getPerformanceNaviga : []);
  return serverTimingsByName;
}

/**
 * If we have the edge's view of ttfb and the clients view as well, then we should take the gap between them as
 * the offset to use foe edge start time.
 * This will simulate the network delays between the client and the edge as an edge startTime increase
 */
function getEdgeOffset(edgeTtfb) {
  var _getPerformanceNaviga4;
  const clientTtfb = (_getPerformanceNaviga4 = getPerformanceNavigationTiming()) === null || _getPerformanceNaviga4 === void 0 ? void 0 : _getPerformanceNaviga4.responseStart;
  if (edgeTtfb == null || clientTtfb == null) {
    return 0;
  }
  return clientTtfb - edgeTtfb;
}
export function getEdgeTimingsIncludingCloudfront() {
  var _serverTimingsByName$, _serverTimingsByName$2, _serverTimingsByName$3, _serverTimingsByName$4, _serverTimingsByName$5, _serverTimingsByName$6, _serverTimingsByName$7, _serverTimingsByName$8, _serverTimingsByName$9;
  const serverTimingsByName = getServerTimingsByName();
  const edgeTotalDuration = (_serverTimingsByName$ = (_serverTimingsByName$2 = serverTimingsByName['cdn-downstream-fbl']) === null || _serverTimingsByName$2 === void 0 ? void 0 : _serverTimingsByName$2.duration) !== null && _serverTimingsByName$ !== void 0 ? _serverTimingsByName$ : (_serverTimingsByName$3 = serverTimingsByName['atl-edge']) === null || _serverTimingsByName$3 === void 0 ? void 0 : _serverTimingsByName$3.duration;
  if (!edgeTotalDuration) {
    return null;
  }
  const edgeOffset = getEdgeOffset(edgeTotalDuration);
  const cfInternalDuration = (((_serverTimingsByName$4 = serverTimingsByName['cdn-upstream-dns']) === null || _serverTimingsByName$4 === void 0 ? void 0 : _serverTimingsByName$4.duration) || 0) + (((_serverTimingsByName$5 = serverTimingsByName['cdn-upstream-connect']) === null || _serverTimingsByName$5 === void 0 ? void 0 : _serverTimingsByName$5.duration) || 0);
  const cfUpstreamDuration = (((_serverTimingsByName$6 = serverTimingsByName['cdn-upstream-fbl']) === null || _serverTimingsByName$6 === void 0 ? void 0 : _serverTimingsByName$6.duration) || 0) - cfInternalDuration;
  const cfDownstreamDuration = (((_serverTimingsByName$7 = serverTimingsByName['cdn-downstream-fbl']) === null || _serverTimingsByName$7 === void 0 ? void 0 : _serverTimingsByName$7.duration) || 0) - (((_serverTimingsByName$8 = serverTimingsByName['cdn-upstream-fbl']) === null || _serverTimingsByName$8 === void 0 ? void 0 : _serverTimingsByName$8.duration) || 0);
  const atlEdgeDuration = (_serverTimingsByName$9 = serverTimingsByName['atl-edge']) === null || _serverTimingsByName$9 === void 0 ? void 0 : _serverTimingsByName$9.duration;
  const cfToAtlEdgeNetworkDuration = cfUpstreamDuration - atlEdgeDuration;
  const edgeTimings = {
    edge: {
      startTime: edgeOffset,
      duration: edgeTotalDuration
    }
  };
  if (typeof serverTimingsByName['cdn-downstream-fbl'] !== 'undefined') {
    var _serverTimingsByName$0;
    edgeTimings['edge/cf'] = {
      startTime: edgeOffset,
      duration: (_serverTimingsByName$0 = serverTimingsByName['cdn-downstream-fbl']) === null || _serverTimingsByName$0 === void 0 ? void 0 : _serverTimingsByName$0.duration
    };
    edgeTimings['edge/cf/internal'] = {
      startTime: edgeOffset,
      duration: cfInternalDuration
    };
    edgeTimings['edge/cf/upstream'] = {
      startTime: edgeOffset + cfInternalDuration,
      duration: cfUpstreamDuration
    };
    edgeTimings['edge/cf/downstream'] = {
      startTime: edgeOffset + cfInternalDuration + cfUpstreamDuration,
      duration: cfDownstreamDuration
    };
  }
  if (typeof serverTimingsByName['atl-edge'] !== 'undefined') {
    var _serverTimingsByName$1;
    edgeTimings['edge/atl-edge'] = {
      startTime: edgeOffset + cfInternalDuration + cfToAtlEdgeNetworkDuration,
      duration: atlEdgeDuration
    };
    edgeTimings['edge/atl-edge/internal'] = {
      startTime: edgeOffset + cfInternalDuration + cfToAtlEdgeNetworkDuration,
      duration: (_serverTimingsByName$1 = serverTimingsByName['atl-edge-internal']) === null || _serverTimingsByName$1 === void 0 ? void 0 : _serverTimingsByName$1.duration
    };
    edgeTimings['edge/atl-edge/ttfb'] = {
      startTime: edgeOffset + cfInternalDuration + cfToAtlEdgeNetworkDuration,
      duration: atlEdgeDuration
    };
    edgeTimings['edge/cf/upstream/network'] = {
      startTime: edgeOffset + cfInternalDuration,
      duration: cfToAtlEdgeNetworkDuration
    };
  }

  // we need a timer here to prevent UFO pipeline from shifting SSR timers to start at 0
  (edgeTimings === null || edgeTimings === void 0 ? void 0 : edgeTimings.edge) && edgeOffset && Object.assign(edgeTimings, {
    'client-network': {
      startTime: 0,
      duration: edgeOffset
    }
  });
  return edgeTimings;
}
export function getSSRTimings() {
  var _config;
  const defaultSSRTimings = getEdgeTimingsIncludingCloudfront() || {};
  let configTimings = {};
  if (typeof ((_config = config) === null || _config === void 0 ? void 0 : _config.getTimings) === 'function') {
    configTimings = config.getTimings();
  }
  const ssrTimings = Object.entries({
    ...configTimings,
    ...defaultSSRTimings
  }).reduce((acc, entry) => {
    if (filterEntry(entry[1])) {
      acc[mapKey(entry[0])] = mapEntry(entry[1]);
    }
    return acc;
  }, {});
  return ssrTimings;
}
export function getSSRSuccess() {
  var _config2;
  return !!((_config2 = config) !== null && _config2 !== void 0 && _config2.getDoneMark());
}
export function getSSRPhaseSuccess() {
  var _config3, _config3$getSsrPhaseS;
  return (_config3 = config) === null || _config3 === void 0 ? void 0 : (_config3$getSsrPhaseS = _config3.getSsrPhaseSuccess) === null || _config3$getSsrPhaseS === void 0 ? void 0 : _config3$getSsrPhaseS.call(_config3);
}
export function getSSRDoneTime() {
  var _config$getDoneMark, _config4;
  return (_config$getDoneMark = (_config4 = config) === null || _config4 === void 0 ? void 0 : _config4.getDoneMark()) !== null && _config$getDoneMark !== void 0 ? _config$getDoneMark : undefined;
}
export function getSSRFeatureFlags() {
  var _config5;
  if (!((_config5 = config) !== null && _config5 !== void 0 && _config5.getFeatureFlags)) {
    return undefined;
  }
  try {
    var _config$getFeatureFla;
    return (_config$getFeatureFla = config.getFeatureFlags()) !== null && _config$getFeatureFla !== void 0 ? _config$getFeatureFla : undefined;
    // eslint-disable-next-line no-empty
  } catch {}
  return undefined;
}