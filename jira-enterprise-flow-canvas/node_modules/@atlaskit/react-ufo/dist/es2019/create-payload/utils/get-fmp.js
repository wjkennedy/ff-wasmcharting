import { getConfig } from '../../config';
import { findMatchingLegacyMetric } from './find-matching-legacy-metric';

/**
 * Calculate FMP (First Meaningful Paint) based on interaction type and configuration
 * FMP is calculated based on legacy metrics or marks depending on interaction type and configuration
 */
export function getFMP(interaction, experienceName) {
  var _config$ssr, _config$ssr$getSSRDon, _config$ssr2;
  const {
    start,
    type,
    marks
  } = interaction;
  const config = getConfig();
  const ssrDoneTime = config === null || config === void 0 ? void 0 : (_config$ssr = config.ssr) === null || _config$ssr === void 0 ? void 0 : (_config$ssr$getSSRDon = _config$ssr.getSSRDoneTime) === null || _config$ssr$getSSRDon === void 0 ? void 0 : _config$ssr$getSSRDon.call(_config$ssr);
  const isBM3ConfigSSRDoneAsFmp = interaction.metaData.__legacy__bm3ConfigSSRDoneAsFmp;
  const isUFOConfigSSRDoneAsFmp = interaction.metaData.__legacy__bm3ConfigSSRDoneAsFmp || !!(config !== null && config !== void 0 && (_config$ssr2 = config.ssr) !== null && _config$ssr2 !== void 0 && _config$ssr2.getSSRDoneTime);

  // Find matching legacy metric
  const matchingLegacyMetric = findMatchingLegacyMetric(interaction, experienceName);
  let fmp;
  if (type === 'page_load' || type === 'transition') {
    if (interaction.legacyMetrics && matchingLegacyMetric) {
      // Check if legacy metric has FMP
      const legacyFmp = matchingLegacyMetric.fmp; // BM3Event doesn't have fmp in types, but it might exist
      if (legacyFmp) {
        fmp = Math.round(legacyFmp - start);
      }
      // If no FMP in legacy metric, return undefined (don't calculate fallback)
    }
  }
  if (type === 'page_load' && fmp === undefined) {
    if (isBM3ConfigSSRDoneAsFmp || isUFOConfigSSRDoneAsFmp) {
      var _marks$find;
      const foundMark = marks === null || marks === void 0 ? void 0 : (_marks$find = marks.find(mark => mark.name === 'fmp')) === null || _marks$find === void 0 ? void 0 : _marks$find.time;
      if (foundMark) {
        fmp = Math.round(foundMark - start);
      } else if (ssrDoneTime) {
        fmp = Math.round(ssrDoneTime - start);
      }
      // If no FMP mark and no SSR done time, fmp remains undefined
    }
    // If not using SSR config, fmp remains undefined for page_load without legacy metrics
  }
  return fmp;
}