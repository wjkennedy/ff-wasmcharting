import { findMatchingLegacyMetric } from './find-matching-legacy-metric';

/**
 * Calculate TTI (Time to Interactive) based on server-side logic
 * TTI is the time from interaction start to the end of the first matching legacy metric,
 * or falls back to apdex/UFO end time if no legacy metrics exist
 */
export function getTTI(interaction, experienceName) {
  var _apdex$;
  const {
    start,
    end,
    apdex
  } = interaction;

  // Find matching legacy metric
  const matchingLegacyMetric = findMatchingLegacyMetric(interaction, experienceName);

  // Get end times in priority order (following server-side logic)
  const apdexEndTime = apdex === null || apdex === void 0 ? void 0 : (_apdex$ = apdex[0]) === null || _apdex$ === void 0 ? void 0 : _apdex$.stopTime;
  const legacyMetricsEndTime = matchingLegacyMetric === null || matchingLegacyMetric === void 0 ? void 0 : matchingLegacyMetric.stop;
  const ufoEndTime = end;
  let ttiEndTime;
  if (matchingLegacyMetric && legacyMetricsEndTime) {
    // Use legacy metrics end time if we have a matching legacy metric
    ttiEndTime = legacyMetricsEndTime;
  } else if (apdexEndTime) {
    // Fall back to apdex end time if no matching legacy metrics
    ttiEndTime = apdexEndTime;
  } else {
    // Final fallback to UFO end time
    ttiEndTime = ufoEndTime;
  }
  return ttiEndTime ? Math.round(ttiEndTime - start) : undefined;
}