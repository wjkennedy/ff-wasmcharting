import { context, createContextKey, ROOT_CONTEXT } from '@opentelemetry/api';
import { fg } from '@atlaskit/platform-feature-flags';
import { getContextManager, UFOContextManager } from './context-manager';
import { makeTraceHttpRequestHeaders } from './utils/make-trace-http-request-headers';
var state = {
  context: null
};
var traceIdKey = createContextKey("traceId");
var spanIdKey = createContextKey("spanId");
var experienceTypeKey = createContextKey("type");

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
export function generateSpanId() {
  return Array.from(new Array(16), function () {
    return Math.floor(Math.random() * 16).toString(16);
  }).join('');
}

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
export function setInteractionActiveTrace(interactionId, experienceType) {
  setActiveTrace(interactionId.replace(/-/g, ''), generateSpanId(), experienceType);
}

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
export function setActiveTrace(traceId, spanId, type) {
  if (fg('platform_ufo_enable_otel_context_manager')) {
    var activeTraceContext = ROOT_CONTEXT.setValue(traceIdKey, traceId).setValue(spanIdKey, spanId).setValue(experienceTypeKey, type);

    // Now we need to get the global Context Manager and set the active context
    // Using type assertion because we've "extended" the ContextManager type
    if (getContextManager() instanceof UFOContextManager) {
      var contextManager = getContextManager();
      contextManager.setActive(activeTraceContext);
    }
  } else {
    state.context = {
      traceId: traceId,
      spanId: spanId,
      type: type
    };
  }
}
export function getActiveTrace() {
  if (fg('platform_ufo_enable_otel_context_manager')) {
    // Get trace context from active context
    var activeTraceContext = {
      traceId: String(context.active().getValue(traceIdKey)),
      spanId: String(context.active().getValue(spanIdKey)),
      type: String(context.active().getValue(experienceTypeKey))
    };

    // Return activeTraceContext if traceId and spanId are not "undefined"
    return activeTraceContext.traceId !== 'undefined' && activeTraceContext.spanId !== 'undefined' ? activeTraceContext : undefined;
  } else {
    return state.context || undefined;
  }
}

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
export function clearActiveTrace() {
  if (fg('platform_ufo_enable_otel_context_manager')) {
    // Now we need to get the global Context Manager and set the active context
    // Using type assertion because we've "extended" the ContextManager type
    if (getContextManager() instanceof UFOContextManager) {
      var contextManager = getContextManager();

      // ROOT_CONTEXT is an empty context used to initialise ContextManagers
      contextManager.setActive(ROOT_CONTEXT);
    }
  } else {
    state.context = null;
  }
}
export function getActiveTraceHttpRequestHeaders(_url) {
  if (getActiveTrace() === undefined) {
    return null;
  }
  var _ref = getActiveTrace(),
    traceId = _ref.traceId,
    spanId = _ref.spanId;
  return makeTraceHttpRequestHeaders(traceId, spanId);
}
export function getActiveTraceAsQueryParams(_url) {
  var traceHeaders = getActiveTraceHttpRequestHeaders();
  return traceHeaders ? new URLSearchParams(traceHeaders).toString().toLowerCase() : null;
}