"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.clearActiveTrace = clearActiveTrace;
exports.generateSpanId = generateSpanId;
exports.getActiveTrace = getActiveTrace;
exports.getActiveTraceAsQueryParams = getActiveTraceAsQueryParams;
exports.getActiveTraceHttpRequestHeaders = getActiveTraceHttpRequestHeaders;
exports.setActiveTrace = setActiveTrace;
exports.setInteractionActiveTrace = setInteractionActiveTrace;
var _api = require("@opentelemetry/api");
var _platformFeatureFlags = require("@atlaskit/platform-feature-flags");
var _contextManager = require("./context-manager");
var _makeTraceHttpRequestHeaders = require("./utils/make-trace-http-request-headers");
var state = {
  context: null
};
var traceIdKey = (0, _api.createContextKey)("traceId");
var spanIdKey = (0, _api.createContextKey)("spanId");
var experienceTypeKey = (0, _api.createContextKey)("type");

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
function generateSpanId() {
  return Array.from(new Array(16), function () {
    return Math.floor(Math.random() * 16).toString(16);
  }).join('');
}

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
function setInteractionActiveTrace(interactionId, experienceType) {
  setActiveTrace(interactionId.replace(/-/g, ''), generateSpanId(), experienceType);
}

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
function setActiveTrace(traceId, spanId, type) {
  if ((0, _platformFeatureFlags.fg)('platform_ufo_enable_otel_context_manager')) {
    var activeTraceContext = _api.ROOT_CONTEXT.setValue(traceIdKey, traceId).setValue(spanIdKey, spanId).setValue(experienceTypeKey, type);

    // Now we need to get the global Context Manager and set the active context
    // Using type assertion because we've "extended" the ContextManager type
    if ((0, _contextManager.getContextManager)() instanceof _contextManager.UFOContextManager) {
      var contextManager = (0, _contextManager.getContextManager)();
      contextManager.setActive(activeTraceContext);
    }
  } else {
    state.context = {
      traceId: traceId,
      spanId: spanId,
      type: type
    };
  }
}
function getActiveTrace() {
  if ((0, _platformFeatureFlags.fg)('platform_ufo_enable_otel_context_manager')) {
    // Get trace context from active context
    var activeTraceContext = {
      traceId: String(_api.context.active().getValue(traceIdKey)),
      spanId: String(_api.context.active().getValue(spanIdKey)),
      type: String(_api.context.active().getValue(experienceTypeKey))
    };

    // Return activeTraceContext if traceId and spanId are not "undefined"
    return activeTraceContext.traceId !== 'undefined' && activeTraceContext.spanId !== 'undefined' ? activeTraceContext : undefined;
  } else {
    return state.context || undefined;
  }
}

// DO NOT CALL THIS FUNCTION DIRECTLY!!!!
// It is only to be called by React UFO libraries for the automatic handling of trace context for experiences.
// Calling this may cause trace context to be broken
function clearActiveTrace() {
  if ((0, _platformFeatureFlags.fg)('platform_ufo_enable_otel_context_manager')) {
    // Now we need to get the global Context Manager and set the active context
    // Using type assertion because we've "extended" the ContextManager type
    if ((0, _contextManager.getContextManager)() instanceof _contextManager.UFOContextManager) {
      var contextManager = (0, _contextManager.getContextManager)();

      // ROOT_CONTEXT is an empty context used to initialise ContextManagers
      contextManager.setActive(_api.ROOT_CONTEXT);
    }
  } else {
    state.context = null;
  }
}
function getActiveTraceHttpRequestHeaders(_url) {
  if (getActiveTrace() === undefined) {
    return null;
  }
  var _ref = getActiveTrace(),
    traceId = _ref.traceId,
    spanId = _ref.spanId;
  return (0, _makeTraceHttpRequestHeaders.makeTraceHttpRequestHeaders)(traceId, spanId);
}
function getActiveTraceAsQueryParams(_url) {
  var traceHeaders = getActiveTraceHttpRequestHeaders();
  return traceHeaders ? new URLSearchParams(traceHeaders).toString().toLowerCase() : null;
}