"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _uuid = require("uuid");
var _coinflip = _interopRequireDefault(require("../../coinflip"));
var _config = require("../../config");
var _experienceTraceIdContext = require("../../experience-trace-id-context");
var _interactionIdContext = require("../../interaction-id-context");
var _interactionMetrics = require("../../interaction-metrics");
var _routeNameContext = _interopRequireDefault(require("../../route-name-context"));
// eslint-disable-next-line @atlaskit/platform/prefer-crypto-random-uuid -- Use crypto.randomUUID instead

function traceUFOInteraction(name, interactionType, startTime) {
  var _getMinorInteractions;
  var rate = (0, _config.getInteractionRate)(name, interactionType);
  var pressInteractionsList = (0, _config.getDoNotAbortActivePressInteraction)();
  var minorInteractions = (pressInteractionsList !== null && pressInteractionsList !== void 0 ? pressInteractionsList : []).concat((_getMinorInteractions = (0, _config.getMinorInteractions)()) !== null && _getMinorInteractions !== void 0 ? _getMinorInteractions : []);
  if (minorInteractions.includes(name)) {
    var _activeInteraction$mi;
    var activeInteraction = (0, _interactionMetrics.getActiveInteraction)();
    activeInteraction === null || activeInteraction === void 0 || (_activeInteraction$mi = activeInteraction.minorInteractions) === null || _activeInteraction$mi === void 0 || _activeInteraction$mi.push({
      name: name,
      startTime: startTime !== null && startTime !== void 0 ? startTime : performance.now()
    });
    return;
  } else {
    (0, _interactionMetrics.abortAll)('new_interaction', name);
  }
  if ((0, _coinflip.default)(rate)) {
    var startTimestamp = startTime !== null && startTime !== void 0 ? startTime : performance.now();
    // eslint-disable-next-line @atlaskit/platform/prefer-crypto-random-uuid -- Use crypto.randomUUID instead
    var newId = (0, _uuid.v4)();
    _interactionIdContext.DefaultInteractionID.current = newId;

    // covered experiences with tracing instrumentation:
    // inline-result.inline-card-create-submit
    (0, _experienceTraceIdContext.setInteractionActiveTrace)(newId, interactionType);
    (0, _interactionMetrics.addNewInteraction)(newId, name, interactionType === 'hover' ? 'press' : interactionType,
    // TODO add dedicated type for hover, might change backend though
    startTimestamp, rate, [], _routeNameContext.default.current, (0, _experienceTraceIdContext.getActiveTrace)());
  }
}
var _default = exports.default = traceUFOInteraction;