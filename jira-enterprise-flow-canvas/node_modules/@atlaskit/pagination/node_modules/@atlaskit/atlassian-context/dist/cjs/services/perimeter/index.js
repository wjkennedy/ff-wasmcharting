"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.cloudEnvironment = cloudEnvironment;
exports.isFedrampModerate = isFedrampModerate;
exports.isIsolatedCloud = isIsolatedCloud;
exports.isolatedCloudDomain = isolatedCloudDomain;
exports.isolationContextId = isolationContextId;
var _constants = require("../../common/constants");
var _atlCookiesLookup = require("../atl-cookies-lookup");
/**
 * Determines if the current perimeter is an Isolated Cloud L2 perimeter
 *
 * @returns {boolean} True if the current perimeter is an Isolated Cloud perimeter, false otherwise
 */
function isIsolatedCloud() {
  if (typeof document === 'undefined') {
    // @ts-ignore
    return globalThis.ssrContext.isInIC;
  }
  var atlCtxCookieValues = (0, _atlCookiesLookup.parseAtlCtxCookies)();
  if (!atlCtxCookieValues) {
    // If the cookies are not set, the current perimeter is non-isolated commercial
    return false;
  }

  // The icDomain check is needed for when federal perimeters are eventually added to Isolated Cloud as well
  return _constants.ISOLATED_CLOUD_PERIMETERS.includes(atlCtxCookieValues.perimeter) && atlCtxCookieValues.icDomain !== undefined;
}

/**
 * Determines if the current perimeter is FedRAMP Moderate.
 * Please note that FedRAMP Moderate is not currently in Isolated Cloud, but when it is, this function will still return true.
 *
 * @returns {boolean} True if the current perimeter is FedRAMP Moderate, false otherwise
 */
function isFedrampModerate() {
  if (typeof document === 'undefined') {
    // @ts-ignore
    return globalThis.ssrContext.isInFedramp;
  }
  var atlCtxCookieValues = (0, _atlCookiesLookup.parseAtlCtxCookies)();
  if (!atlCtxCookieValues) {
    // If the cookies are not set, the current perimeter is non-isolated commercial
    return false;
  }
  return atlCtxCookieValues.perimeter === _constants.FEDRAMP_MODERATE;
}

/**
 * Retrieves the customer selected IC domain name.
 *
 *
 * @returns {string | undefined} The Isolated Cloud domain name if applicable, undefined otherwise (ex. if not in Isolated Cloud)
 */
function isolatedCloudDomain() {
  if (typeof document === 'undefined') {
    return globalThis.location.hostname;
  }
  var atlCtxCookieValues = (0, _atlCookiesLookup.parseAtlCtxCookies)();
  return atlCtxCookieValues === null || atlCtxCookieValues === void 0 ? void 0 : atlCtxCookieValues.icDomain;
}

/**
 * Returns the Isolation Context identifier
 *
 * @returns {string | undefined} The Isolation Context ID if applicable, undefined otherwise (ex. if not in Isolated Cloud)
 */
function isolationContextId() {
  if (typeof document === 'undefined') {
    // @ts-ignore
    return isIsolatedCloud() ? globalThis.ssrContext.icName : undefined;
  }
  var atlCtxCookieValues = (0, _atlCookiesLookup.parseAtlCtxCookies)();
  return atlCtxCookieValues === null || atlCtxCookieValues === void 0 ? void 0 : atlCtxCookieValues.icId;
}

/**
 * Returns information about the current environment for internal use
 * @returns {string | undefined} if the current environment is in isolated cloud + what the current perimeter is. Returns undefined when a new cloud environment has been created but not added to this library
 */
function cloudEnvironment() {
  if (typeof document === 'undefined') {
    return cloudEnvironmentSsrLookup();
  }
  return cloudEnvironmentCookieLookup();
}
function cloudEnvironmentSsrLookup() {
  // @ts-ignore
  if (globalThis.ssrContext.isInIC === true) {
    return {
      type: 'isolated-cloud',
      perimeter: _constants.COMMERCIAL
    };
  }
  // @ts-ignore
  if (globalThis.ssrContext.isInFedramp === true) {
    return {
      type: 'non-isolated-cloud',
      perimeter: _constants.FEDRAMP_MODERATE
    };
  }
  return {
    type: 'non-isolated-cloud',
    perimeter: _constants.COMMERCIAL
  };
}
function cloudEnvironmentCookieLookup() {
  // Avoid calling isFedrampModerate() and isIsolatedCloud() here to avoid repeated cookie parsing
  var atlCtxCookieValues = (0, _atlCookiesLookup.parseAtlCtxCookies)();
  if (!atlCtxCookieValues) {
    // If the cookies are not set, the current perimeter is non-isolated commercial
    return {
      type: 'non-isolated-cloud',
      perimeter: _constants.COMMERCIAL
    };
  }
  var isIc = _constants.ISOLATED_CLOUD_PERIMETERS.includes(atlCtxCookieValues.perimeter) && atlCtxCookieValues.icDomain !== undefined;
  if (isIc) {
    return {
      type: 'isolated-cloud',
      perimeter: _constants.COMMERCIAL
    };
  }
  if (atlCtxCookieValues.perimeter === _constants.FEDRAMP_MODERATE) {
    return {
      type: 'non-isolated-cloud',
      perimeter: _constants.FEDRAMP_MODERATE
    };
  }

  // If a new cloud environment has been created but not added to this library, return undefined
  return undefined;
}