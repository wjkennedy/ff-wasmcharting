"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.download = void 0;
const invoke_1 = require("../invoke");
const errors_1 = require("../errors");
const utils_1 = require("./utils");
const bridge_1 = require("../bridge");
const callBridge = (0, bridge_1.getCallBridge)();
const download = async ({ functionKey, keys }) => {
    await (0, utils_1.checkRestrictedEnvironment)();
    void callBridge('trackObjectStoreAction', { action: 'download' });
    if (!functionKey || functionKey.length === 0) {
        throw new errors_1.BridgeAPIError('functionKey is required to filter and generate download URLs');
    }
    if (!Array.isArray(keys) || keys.length === 0) {
        throw new errors_1.BridgeAPIError('keys array is required and must not be empty');
    }
    const downloadUrlsTokeys = (await (0, invoke_1.invoke)(functionKey, {
        keys
    }));
    if (!downloadUrlsTokeys || typeof downloadUrlsTokeys !== 'object') {
        throw new errors_1.BridgeAPIError('Invalid response from functionKey');
    }
    const downloadPromises = Object.entries(downloadUrlsTokeys).map(async ([downloadUrl, key]) => {
        try {
            const response = await fetch(downloadUrl, {
                method: 'GET'
            });
            if (!response.ok) {
                return {
                    success: false,
                    key: key,
                    status: response.status,
                    error: `Download failed with status ${response.status}`
                };
            }
            const blob = await response.blob();
            return {
                success: true,
                key: key,
                blob,
                status: response.status
            };
        }
        catch (error) {
            return {
                success: false,
                key: key,
                status: 503,
                error: error instanceof Error ? error.message : 'Download failed'
            };
        }
    });
    const results = await Promise.all(downloadPromises);
    return results;
};
exports.download = download;
